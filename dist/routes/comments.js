const express=require("express"),router=express.Router({mergeParams:!0}),Campground=require("../models/campground"),Comment=require("../models/comments"),isLoggedIn=require("../middleware/isLoggedIn");isCommentOwner=require("../middleware/isCommentOwner"),router.get("/new",isLoggedIn,async(e,r,m)=>{try{const t=await Campground.findById(e.params.id);r.render("comments/new-comment",{campground:t})}catch(e){return e.shouldRedirect=!0,m(e)}}),router.post("/",isLoggedIn,async(e,r,m)=>{try{const t=await Campground.findById(e.params.id).populate("comments"),n=await Comment.create(e.body.comment);return n.author.id=e.user._id,n.author.username=e.user.username,n.save(),t.comments.push(n),t.save(),e.flash("success","New comment added!"),r.render("campgrounds/show-campground",{campground:t,api:process.env.GEOCODER_API_KEY_RESTRICTED,success:"Comment succesfully added!"})}catch(e){return e.shouldRedirect=!0,m(e)}}),router.get("/:comment_id/edit",isCommentOwner,async(e,r,m)=>{try{const t=await Campground.findById(e.params.id),n=await Comment.findById(e.params.comment_id);return r.render("comments/edit-comment",{campground:t,comment:n})}catch(e){return e.shouldRedirect=!0,m(e)}}),router.put("/:comment_id",isCommentOwner,async(e,r,m)=>{try{return await Comment.findByIdAndUpdate(e.params.comment_id,e.body.comment),e.flash("success","Comment succesfully updated!"),r.redirect(`/campgrounds/${e.params.id}`)}catch(e){return e.shouldRedirect=!0,m(e)}}),router.delete("/:comment_id",isCommentOwner,async(e,r,m)=>{try{return await Comment.findByIdAndRemove(e.params.comment_id),e.flash("success","Comment succesfully deleted!"),r.redirect(`/campgrounds/${e.params.id}`)}catch(e){return e.shouldRedirect=!0,m(e)}}),module.exports=router;