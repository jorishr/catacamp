const express=require("express"),router=express.Router({mergeParams:!0}),Campground=require("../models/campground"),Comment=require("../models/comments"),middleware=require("../middleware");router.get("/new",middleware.isLoggedIn,(e,r,m)=>{Campground.findById(e.params.id,(e,d)=>{if(e)return e.shouldRedirect=!0,m(e);r.render("comments/new-comment",{campground:d})})}),router.post("/",middleware.isLoggedIn,(e,r,m)=>{Campground.findById(e.params.id,(d,o)=>{if(d)return d.shouldRedirect=!0,m(d);Comment.create(e.body.comment,(d,n)=>{if(d)return d.shouldRedirect=!0,m(d);n.author.id=e.user._id,n.author.username=e.user.username,n.save(),console.log(`Saved comment in DB:\n${n}\nComment made by: ${e.user.username}`),o.comments.push(n),o.save(),e.flash("success","New comment added!"),r.redirect(`/campgrounds/${e.params.id}`)})})}),router.get("/:comment_id/edit",middleware.checkCommentOwnership,(e,r,m)=>{Campground.findById(e.params.id,(d,o)=>{if(d)return d.shouldRedirect=!0,m(d);Comment.findById(e.params.comment_id,(e,d)=>{if(e)return e.shouldRedirect=!0,m(e);r.render("comments/edit-comment",{campground:o,comment:d})})})}),router.put("/:comment_id",middleware.checkCommentOwnership,(e,r,m)=>{Comment.findByIdAndUpdate(e.params.comment_id,e.body.comment,(d,o)=>{if(d)return d.shouldRedirect=!0,m(d);e.flash("success","Comment succesfully updated!"),r.redirect(`/campgrounds/${e.params.id}`)})}),router.delete("/:comment_id",middleware.checkCommentOwnership,(e,r,m)=>{Comment.findByIdAndRemove(e.params.comment_id,d=>{if(d)return d.shouldRedirect=!0,m(d);e.flash("success","Comment succesfully deleted!"),r.redirect(`/campgrounds/${e.params.id}`),console.log("Succesfully deleted comment")})}),module.exports=router;