const Campground=require("../models/campground"),Comment=require("../models/comments"),User=require("../models/user");middlewareObj={},middlewareObj.isLoggedIn=function(e,r,o){if(e.isAuthenticated())return o();e.flash("error","You need to be logged in!"),r.redirect("/login")},middlewareObj.checkCampgroundOwnership=function(e,r,o){e.isAuthenticated()?Campground.findById(e.params.id,(d,i)=>{d||!i?(e.flash("error","No corresponding data found in the database!"),r.redirect("/campgrounds")):i.author.id.equals(e.user._id)||e.user.isAdmin?o():(e.flash("error","You don't have permission to do that!"),r.redirect("/campgrounds"))}):(e.flash("error","You need to be logged in!"),r.redirect("/campgrounds"))},middlewareObj.checkCommentOwnership=function(e,r,o){e.isAuthenticated()?Comment.findById(e.params.comment_id,(d,i)=>{d||!i?(e.flash("error","No corresponding comment found in the database!"),r.redirect("back")):i.author.id.equals(e.user._id)||e.user.isAdmin?o():(e.flash("error","You don't have permission to do that!"),r.redirect("/campgrounds"))}):(e.flash("error","You need to be logged in!"),r.redirect("/campgrounds"))},middlewareObj.checkProfileOwnership=function(e,r,o){e.isAuthenticated()?User.findById(e.params.id,(d,i)=>{d?(console.log("\nError looking up user id:\n",d),e.flash("error","Something went wrong, try again."),r.redirect("back")):i._id.equals(e.user._id)||e.user.isAdmin?o():(e.flash("error","You don't have permission to do that!"),r.redirect("/campgrounds"))}):(e.flash("error","You need to be logged in!"),r.redirect("/campgrounds"))},middlewareObj.ipRestricted=function(e,r,o){(e.ip||e.headers["x-forwarded-for"]||e.connection.remoteAddress||e.socket.remoteAddress||e.connection.socket.remoteAddress)===process.env.LOCAL_IP?o():(console.log("\nReceived a request from a non-approved IP address"),e.flash("error",`This action is disabled for security reasons. Please find the contact details of the site admin at ${process.env.SITE_ADMIN}.`),r.redirect("/campgrounds"))},module.exports=middlewareObj;