require("dotenv").config({debug:process.env.DEBUG});const path=require("path"),express=require("express"),app=express(),bodyParser=require("body-parser"),mongoose=require("mongoose"),db=mongoose.connection,port=process.env.DB_PORT,methodOverride=require("method-override"),flash=require("connect-flash"),seedDB=require("./seeds"),passport=require("passport"),LocalStrategy=require("passport-local"),expressSession=require("express-session"),User=require("./models/user"),indexRoutes=require("./routes/index"),commentRoutes=require("./routes/comments"),campgroundRoutes=require("./routes/campgrounds"),resetPwRoutes=require("./routes/reset_pw"),userProfileRoutes=require("./routes/profile"),errorHandler=require("./middleware/error"),favicon=require("serve-favicon");mongoose.connect(process.env.DB_CONN_CLOUD,{useNewUrlParser:!0}),db.on("error",console.error.bind(console,"\nConnection error:\n")),db.once("open",()=>{console.log("\nDatabase connection established")}),app.listen(port,()=>console.log(`\nExpress Server is listening on port ${port}`)),app.use(express.static(path.join(__dirname,"public"))),app.use(methodOverride("_method")),app.use(bodyParser.urlencoded({extended:!0})),app.use(flash()),app.use(favicon(path.join(__dirname,"public","images","favicon.ico"))),app.set("views",path.join(__dirname,"views")),app.set("view engine","ejs"),app.locals.moment=require("moment"),app.use(expressSession({secret:process.env.EXPRESS_SECRET,saveUninitialized:!1,resave:!1})),app.use(passport.initialize()),app.use(passport.session()),passport.use(new LocalStrategy(User.authenticate())),passport.serializeUser(User.serializeUser()),passport.deserializeUser(User.deserializeUser()),app.use((e,r,s)=>{r.locals.currentUser=e.user,r.locals.error=e.flash("error"),r.locals.success=e.flash("success"),s()}),app.use(indexRoutes),app.use("/campgrounds/:id/comments",commentRoutes),app.use("/campgrounds",campgroundRoutes),app.use(resetPwRoutes),app.use("/user",userProfileRoutes),app.get("*",(e,r,s)=>{let o=new Error(`The page: '${e.originalUrl}' does not exist or cannot be found!`);o.messageForConsole=`${e.ip} tried to reach ${e.originalUrl}`,o.statusCode=404,o.shouldRedirect=!0,s(o)}),app.use(errorHandler);